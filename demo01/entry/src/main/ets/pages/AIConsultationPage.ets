import promptAction from '@ohos.promptAction';
import { askAI } from '../utils/api';

interface ChatMessage {
  role: 'user' | 'assistant';
  content: string;
}

@Entry
@Component
struct AIConsultationPage {
  @State question: string = '';
  @State loading: boolean = false;
  // @State chatHistory: ChatMessage[] = [];
  @State chatHistory: ChatMessage[] = [
    {
      role: 'assistant',
      content: 'ä½ å¥½ï¼Œæˆ‘æ˜¯å†œä¸šæ™ºèƒ½é—®ç­”åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ'
    }
  ];

  build() {
    Column() {
      // å¤´éƒ¨æ ‡é¢˜
      Text('ðŸŒ¾ ä½œç‰©æ™ºèƒ½é—®ç­”åŠ©æ‰‹')
        .fontSize(26)
        .fontWeight(FontWeight.Bold)
        .padding({ top: 20, bottom: 12 })
        .alignSelf(ItemAlign.Center);

      // èŠå¤©åŒºåŸŸ
      Scroll() {
        Column({ space: 12 }) {
          ForEach(this.chatHistory, (msg: ChatMessage, index: number) => {
            if (msg.role === 'assistant') {
              // AI æ¶ˆæ¯é å·¦
              Row() {
                Text('ðŸ¤–')
                  .fontSize(20)
                  .margin({ right: 6 });

                Column() {
                  Text(msg.content)
                    .fontSize(16)
                    .fontColor(Color.Black)
                    .backgroundColor('#E0F2F1')
                    .padding(12)
                    .borderRadius(16)
                    .shadow({ radius: 4, color: '#B0BEC5', offsetX: 2, offsetY: 2 })
                    .animation({ duration: 200 });
                }
                .width('83%')  // âœ… æŽ§åˆ¶ assistant æ°”æ³¡æ•´ä½“å®½åº¦
              }
              .width('100%')
              .justifyContent(FlexAlign.Start)
              .padding({ left: 16, right: 16, bottom: 6 });
            } else {
              // ç”¨æˆ·æ¶ˆæ¯é å³
              Row() {
                Text(msg.content)
                  .fontSize(16)
                  .fontColor(Color.Black)
                  .backgroundColor('#BBDEFB')
                  .padding(12)
                  .borderRadius(16)
                  .shadow({ radius: 4, color: '#B0BEC5', offsetX: 2, offsetY: 2 })
                  .animation({ duration: 200 });

                Text('ðŸ‘¤')
                  .fontSize(20)
                  .margin({ left: 6 });
              }
              .width('100%')
              .justifyContent(FlexAlign.End)
              .padding({ left: 16, right: 16, bottom: 10 });
            }
          });

        }
        .padding(10)
      }
      .height('60%')
      .width('100%')
      .backgroundColor('#F5F5F5')
      .borderRadius(12)
      .margin({ bottom: 8 });

      // è¾“å…¥åŒºåŸŸ
      Column({ space: 12 }) {
        TextInput({
          placeholder: 'è¯·è¾“å…¥ä½ çš„é—®é¢˜â€¦',
          text: this.question
        })
          .type(InputType.Normal)
          .height(90)
          .width('90%')
          .fontSize(16)
          .borderRadius(16)
          .padding(12)
          .backgroundColor('#FFFFFF')
          .onChange((value: string) => this.question = value)
          .shadow({ radius: 3, color: '#B0BEC5', offsetX: 1, offsetY: 2 });

        Button(this.loading ? 'â³ æäº¤ä¸­â€¦' : 'ðŸ“© æäº¤é—®é¢˜')
          .width('60%')
          .height(48)
          .fontSize(18)
          .borderRadius(24)
          .backgroundColor(this.loading ? '#BDBDBD' : '#4CAF50')
          .fontColor(Color.White)
          .onClick(() => this.sendMessage());
      }
      .alignItems(HorizontalAlign.Center)
    }
    .padding(20)
    .alignItems(HorizontalAlign.Center)
    .justifyContent(FlexAlign.Start)
    .backgroundColor('#ECEFF1');
  }

  private sendMessage() {
    const question = this.question.trim();
    if (!question) {
      promptAction.showToast({ message: 'è¯·è¾“å…¥é—®é¢˜' });
      return;
    }

    this.loading = true;
    this.chatHistory.push({ role: 'user', content: question });
    this.question = '';

    // æ‹¼æŽ¥ä¸Šä¸‹æ–‡
    const context = this.chatHistory
      .map(msg => `${msg.role === 'user' ? 'ç”¨æˆ·' : 'AI'}ï¼š${msg.content}`)
      .join('\n') + `\nç”¨æˆ·ï¼š${question}`;

    askAI(context)
      .then(reply => {
        this.chatHistory.push({ role: 'assistant', content: reply });
      })
      .catch((err: Error) => {
        console.error(err.message);
        promptAction.showToast({ message: 'AI è¯·æ±‚å¤±è´¥' });
        this.chatHistory.push({ role: 'assistant', content: 'ã€å‡ºé”™ã€‘AI æ— æ³•å›žåº”ï¼Œè¯·ç¨åŽå†è¯•ã€‚' });
      })
      .finally(() => {
        this.loading = false;
      });
  }
}
