import { Crop } from '../model/Crop'
import router from '@ohos.router'
import { getAllCrops } from '../utils/api';
import { BasicConstants } from "../utils/BasicConstants"


@Entry
@Component
export default struct CropInfoPage {

  @State cropList: Crop[] = [];

//   aboutToAppear() {
//     getAllCrops()
//       .then((list) => {
//         this.cropList = list;
//         AppStorage.set('cropList', list);
//
//       })
//       .catch((e: Error) => {
//         console.error('âŒ ä½œç‰©åˆ—è¡¨åŠ è½½å¤±è´¥', e);
//         // prompt.showToast({ message: 'åŠ è½½ä½œç‰©å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' });
//       });
//
// }


  // é¡µé¢å³å°†å‡ºçŽ°æ—¶æ‹‰å–å¹¶å¤„ç†æ•°æ®
  aboutToAppear() {
    getAllCrops()
      .then((list: Crop[]) => {
        const processed: Crop[] = list.map((c: Crop) => {
          // 1. åŽŸå§‹åŽç«¯è¿”å›žçš„ç›¸å¯¹è·¯å¾„
          let path = c.imageUrl ?? ''
          // 2. ä¿è¯ä»¥ â€œ/â€ å¼€å¤´
          if (!path.startsWith('/')) {
            path = '/' + path
          }
          // 3. è¿”å›žä¸€ä¸ªæ–°çš„ Crop å¯¹è±¡ï¼Œå®Œæ•´æ‹¼æŽ¥ URLï¼Œå¹¶ä¿ç•™å…¶å®ƒå­—æ®µ
          return {
            cropId:         c.cropId,
            greenhouseName: c.greenhouseName,
            cropName:       c.cropName,
            plantingDate:   c.plantingDate,
            growthCycle:    c.growthCycle,
            imageUrl:       BasicConstants.BASE_URL + path,
            cropContent:    c.cropContent
          } as Crop
        })
        // æ›´æ–°çŠ¶æ€ï¼Œè§¦å‘é¡µé¢é‡ç»˜
        this.cropList = processed
        AppStorage.setOrCreate('cropList', processed)
      })
      .catch((e: Error) => {
        console.error('âŒ ä½œç‰©åˆ—è¡¨åŠ è½½å¤±è´¥', e)
        // prompt.showToast({ message: 'åŠ è½½ä½œç‰©å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•' })
      })
  }



  build() {
    Column() {
      Text('ä½œç‰©ä¿¡æ¯')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 16 })
        .textAlign(TextAlign.Center)

      Scroll() {
        Column({ space: 16 }) {
          ForEach(this.cropList, (item: Crop) => {
            CropCard(item)
          }, (item: Crop) => item.cropId.toString())
        }
      }
    }
    .padding(16)
    .backgroundColor('#ffffff')
    .height('100%')
  }
}

// âœ… å•ä¸ª Crop å¡ç‰‡ç»„ä»¶ï¼ˆæ— çŠ¶æ€å­—æ®µï¼‰
@Builder
function CropCard(crop: Crop) {
  Column() {
    Row({ space: 12 }) {
      // å·¦ä¾§ï¼šå›¾ç‰‡åŒºåŸŸ
      Column() {
        Image(crop.imageUrl)
          .width(50)
          .height(50)
          .borderRadius(8)
          .objectFit(ImageFit.Contain)
      }
      .layoutWeight(1)

      // å³ä¾§ï¼šæ–‡å­—ä¿¡æ¯
      Column({ space: 4 }) {
        Text(crop.cropName)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)

        Text(`æ‰€å±žå¤§æ£šï¼š${crop.greenhouseName}`)
          .fontSize(14)
          .fontColor('#666')
      }
      .layoutWeight(2)
      .alignItems(HorizontalAlign.Start)

      Blank()
    }
    .onClick(() => {
      router.pushUrl({
        url: 'pages/CropDetailPage',
        params: { crop: JSON.stringify(crop) } // ðŸ‘ˆ ç›´æŽ¥ä¼  JSON å­—ç¬¦ä¸²
      });
    })
  }
  .padding(12)
  .backgroundColor('#f5f5f5')
  .borderRadius(10)
  .width('100%')
}

