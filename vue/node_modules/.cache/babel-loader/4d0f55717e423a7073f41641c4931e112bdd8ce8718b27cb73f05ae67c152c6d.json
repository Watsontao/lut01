{"ast":null,"code":"export default {\n  name: 'TaskList',\n  data() {\n    return {\n      tasks: [],\n      searchKey: '',\n      multipleSelection: [],\n      dialogVisible: false,\n      greenhouses: [],\n      farmers: [],\n      // 这里存放所有农工用户\n      form: {},\n      rules: {\n        name: [{\n          required: true,\n          message: '请输入任务名称',\n          trigger: 'blur'\n        }],\n        taskContent: [{\n          required: true,\n          message: '请输入任务内容',\n          trigger: 'blur'\n        }],\n        taskGreenhouseName: [{\n          required: true,\n          message: '请选择所属大棚',\n          trigger: 'change'\n        }],\n        assignedUserId: [{\n          required: true,\n          message: '请选择指派用户',\n          trigger: 'change'\n        }]\n      }\n    };\n  },\n  computed: {\n    filteredTasks() {\n      const k = this.searchKey.trim();\n      if (!k) return this.tasks;\n      return this.tasks.filter(t => (t.name || '').includes(k) || (t.taskGreenhouseName || '').includes(k) || this.getUserName(t.assignedUserId).includes(k));\n    }\n  },\n  /** 先拉列表 & 农工用户缓存 */\n  created() {\n    this.loadTasks();\n    this.$request.get('/api/user/getFarmers').then(r => {\n      this.farmers = r.data || [];\n    });\n  },\n  methods: {\n    /* 根据 userId 返回用户名；查不到时返回空字符串 */\n    getUserName(id) {\n      const u = this.farmers.find(f => f.userId === id);\n      return u ? u.userName || u.username || '' : '';\n    },\n    /* —— 任务列表 —— */\n    loadTasks() {\n      this.$request.get('/api/task/getAll').then(res => {\n        this.tasks = res.data || [];\n      });\n    },\n    handleDelete(id) {\n      this.$confirm('确认删除该任务？', '提示', {\n        type: 'warning'\n      }).then(() => this.$request.delete(`/api/task/delete/${id}`)).then(() => {\n        this.$message.success('删除成功');\n        this.loadTasks();\n      }).catch(() => {});\n    },\n    handleBatchDelete() {\n      const ids = this.multipleSelection.map(i => i.taskId);\n      if (!ids.length) return;\n      this.$confirm(`确认删除选中的 ${ids.length} 条任务？`, '提示', {\n        type: 'warning'\n      }).then(() => this.$request.post('/api/task/deleteBatch', ids)).then(() => {\n        this.$message.success('删除成功');\n        this.loadTasks();\n      }).catch(() => {});\n    },\n    /* —— 弹窗 —— */\n    openEdit(row = null) {\n      this.form = row ? {\n        ...row\n      } : {\n        completed: '否'\n      };\n      this.dialogVisible = true;\n      this.$nextTick(() => this.$refs.formRef && this.$refs.formRef.clearValidate());\n      if (!this.greenhouses.length) {\n        this.$request.get('/api/greenhouse/getAll').then(r => {\n          this.greenhouses = r.data || [];\n        });\n      }\n      if (!this.farmers.length) {\n        this.$request.get('/api/user/getFarmers').then(r => {\n          this.farmers = r.data || [];\n        });\n      }\n    },\n    submitForm() {\n      this.$refs.formRef.validate(valid => {\n        if (!valid) return;\n        this.$request.post('/api/task/save', this.form).then(() => {\n          this.$message.success('保存成功');\n          this.dialogVisible = false;\n          this.loadTasks();\n        });\n      });\n    },\n    resetForm() {\n      this.$refs.formRef && this.$refs.formRef.resetFields();\n      this.form = {};\n    }\n  }\n};","map":{"version":3,"names":["name","data","tasks","searchKey","multipleSelection","dialogVisible","greenhouses","farmers","form","rules","required","message","trigger","taskContent","taskGreenhouseName","assignedUserId","computed","filteredTasks","k","trim","filter","t","includes","getUserName","created","loadTasks","$request","get","then","r","methods","id","u","find","f","userId","userName","username","res","handleDelete","$confirm","type","delete","$message","success","catch","handleBatchDelete","ids","map","i","taskId","length","post","openEdit","row","completed","$nextTick","$refs","formRef","clearValidate","submitForm","validate","valid","resetForm","resetFields"],"sources":["src/views/manager/TaskList.vue"],"sourcesContent":["<template>\n  <div class=\"task-page\">\n    <!-- ▍工具栏 -->\n    <div class=\"toolbar\">\n      <div>\n        <el-button type=\"success\" @click=\"openEdit()\">新增任务</el-button>\n        <el-button\n            type=\"danger\"\n            :disabled=\"!multipleSelection.length\"\n            @click=\"handleBatchDelete\"\n        >批量删除</el-button>\n      </div>\n\n      <!-- ▍搜索 -->\n      <el-input v-model=\"searchKey\" placeholder=\"搜索任务 / 大棚 / 用户\"\n                size=\"small\" style=\"max-width:260px\" clearable\n                @keyup.enter.native=\"loadTasks\">\n        <template #append>\n          <el-button icon=\"el-icon-search\" @click=\"loadTasks\"/>\n        </template>\n      </el-input>\n    </div>\n\n    <!-- ▍任务表格 -->\n    <el-table :data=\"filteredTasks\" border stripe style=\"width:100%;\"\n              @selection-change=\"multipleSelection = $event\">\n      <el-table-column type=\"selection\" width=\"46\"/>\n      <el-table-column prop=\"taskId\"  label=\"ID\" width=\"70\" align=\"center\"/>\n      <el-table-column prop=\"name\"    label=\"任务名称\" min-width=\"150\"/>\n      <el-table-column prop=\"taskContent\" label=\"任务内容\" min-width=\"180\" show-overflow-tooltip/>\n      <el-table-column prop=\"taskGreenhouseName\" label=\"所属大棚\" min-width=\"120\"/>\n\n      <!-- ✨ 指派用户：用用户名替代 ID -->\n      <el-table-column label=\"指派用户\" width=\"120\">\n        <template #default=\"scope\">\n          {{ getUserName(scope.row.assignedUserId) || ('ID:'+scope.row.assignedUserId) }}\n        </template>\n      </el-table-column>\n\n      <el-table-column label=\"完成状态\" width=\"90\" align=\"center\">\n        <template #default=\"s\">\n          <el-tag :type=\"s.row.completed === '是' ? 'success' : 'info'\" size=\"mini\">\n            {{ s.row.completed === '是' ? '已完成' : '未完成' }}\n          </el-tag>\n        </template>\n      </el-table-column>\n\n      <el-table-column prop=\"publishTime\" label=\"发布时间\" min-width=\"120\"/>\n      <el-table-column prop=\"deadline\"    label=\"截止时间\" min-width=\"120\"/>\n      <el-table-column prop=\"taskDescription\" label=\"备注\" min-width=\"140\" show-overflow-tooltip/>\n\n      <el-table-column label=\"操作\" width=\"180\" fixed=\"right\">\n        <template #default=\"scope\">\n          <el-button size=\"mini\" type=\"primary\" @click=\"openEdit(scope.row)\">编辑</el-button>\n          <el-button size=\"mini\" type=\"danger\"  @click=\"handleDelete(scope.row.taskId)\">删除</el-button>\n        </template>\n      </el-table-column>\n    </el-table>\n\n    <!-- ▍弹窗：新增 / 编辑 -->\n    <!-- ……（下面弹窗代码与之前一致，不再展开）…… -->\n  </div>\n</template>\n\n<script>\nexport default {\n  name: 'TaskList',\n  data () {\n    return {\n      tasks: [],\n      searchKey: '',\n      multipleSelection: [],\n\n      dialogVisible: false,\n      greenhouses: [],\n      farmers: [],        // 这里存放所有农工用户\n      form: {},\n\n      rules: {\n        name:               [{ required: true, message: '请输入任务名称', trigger: 'blur' }],\n        taskContent:        [{ required: true, message: '请输入任务内容', trigger: 'blur' }],\n        taskGreenhouseName: [{ required: true, message: '请选择所属大棚', trigger: 'change' }],\n        assignedUserId:     [{ required: true, message: '请选择指派用户',  trigger: 'change' }]\n      }\n    };\n  },\n\n  computed: {\n    filteredTasks () {\n      const k = this.searchKey.trim();\n      if (!k) return this.tasks;\n      return this.tasks.filter(t =>\n          (t.name || '').includes(k) ||\n          (t.taskGreenhouseName || '').includes(k) ||\n          this.getUserName(t.assignedUserId).includes(k)\n      );\n    }\n  },\n\n  /** 先拉列表 & 农工用户缓存 */\n  created () {\n    this.loadTasks();\n    this.$request.get('/api/user/getFarmers')\n        .then(r => { this.farmers = r.data || []; });\n  },\n\n  methods: {\n    /* 根据 userId 返回用户名；查不到时返回空字符串 */\n    getUserName (id) {\n      const u = this.farmers.find(f => f.userId === id);\n      return u ? u.userName || u.username || '' : '';\n    },\n\n    /* —— 任务列表 —— */\n    loadTasks () {\n      this.$request.get('/api/task/getAll')\n          .then(res => { this.tasks = res.data || []; });\n    },\n\n    handleDelete (id) {\n      this.$confirm('确认删除该任务？', '提示', { type:'warning' })\n          .then(() => this.$request.delete(`/api/task/delete/${id}`))\n          .then(() => { this.$message.success('删除成功'); this.loadTasks(); })\n          .catch(()=>{});\n    },\n\n    handleBatchDelete () {\n      const ids = this.multipleSelection.map(i => i.taskId);\n      if (!ids.length) return;\n      this.$confirm(`确认删除选中的 ${ids.length} 条任务？`, '提示', { type:'warning' })\n          .then(() => this.$request.post('/api/task/deleteBatch', ids))\n          .then(() => { this.$message.success('删除成功'); this.loadTasks(); })\n          .catch(()=>{});\n    },\n\n    /* —— 弹窗 —— */\n    openEdit (row = null) {\n      this.form = row ? { ...row } : { completed:'否' };\n      this.dialogVisible = true;\n      this.$nextTick(() => this.$refs.formRef && this.$refs.formRef.clearValidate());\n\n      if (!this.greenhouses.length) {\n        this.$request.get('/api/greenhouse/getAll')\n            .then(r => { this.greenhouses = r.data || []; });\n      }\n      if (!this.farmers.length) {\n        this.$request.get('/api/user/getFarmers')\n            .then(r => { this.farmers = r.data || []; });\n      }\n    },\n\n    submitForm () {\n      this.$refs.formRef.validate(valid => {\n        if (!valid) return;\n        this.$request.post('/api/task/save', this.form)\n            .then(() => {\n              this.$message.success('保存成功');\n              this.dialogVisible = false;\n              this.loadTasks();\n            });\n      });\n    },\n\n    resetForm () {\n      this.$refs.formRef && this.$refs.formRef.resetFields();\n      this.form = {};\n    }\n  }\n};\n</script>\n\n<style scoped>\n.task-page { padding: 15px; }\n.toolbar   { display:flex; justify-content:space-between; margin-bottom:12px; }\n</style>\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}